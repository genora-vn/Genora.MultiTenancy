@page
@using Genora.MultiTenancy.Localization
@using Genora.MultiTenancy.Web.Pages.AppMembershipTiers
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model CreateModalModel
@inject IStringLocalizer<MultiTenancyResource> L
@{
    Layout = null;
}
<form abp-model="MembershipTier" asp-page="/AppMembershipTiers/CreateModal">
    <abp-modal>
        <abp-modal-header title="@L["CreateAppMembershipTier"].Value"></abp-modal-header>
        <abp-modal-body>
            <div class="d-inline-flex" style="width: 97%; gap: 15px">
                <div class="col-md-5">
                    <abp-input asp-for="MembershipTier.Code" placeholder="Nhập mã hạng (vd: GOLD)" />
                </div>
                <div class="col-md-7">
                    <abp-input asp-for="MembershipTier.Name" placeholder="Nhập tên hạng (vd: Đồng, Bạc, Vàng,...)" />
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="MembershipTier.Description" class="form-label"></label>
                <textarea asp-for="MembershipTier.Description" placeholder="Mô tả chi tiết xếp hạng" rows="3" class="form-control"></textarea>
            </div>

            <div class="d-inline-flex" style="width: 97%; gap: 15px">
                <div class="col-md-5">
                    <abp-input asp-for="MembershipTier.MinTotalSpending" placeholder="Nhập doanh thu tối thiểu" />
                </div>
                <div class="col-md-5">
                    <abp-input asp-for="MembershipTier.MinRounds" placeholder="Nhập lượi chơi tối thiểu" />
                </div>
                <div class="col-md-2">
                    <abp-input asp-for="MembershipTier.EvaluationPeriod" placeholder="Chu kỳ xét tăng hạng" />
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="MembershipTier.Benefits" class="form-label"></label>
                <textarea asp-for="MembershipTier.Benefits" placeholder="Nhập quyền lợi của khách hàng đạt rank" rows="3" class="form-control"></textarea>
            </div>

            <div class="d-inline-flex" style="width: 98%; gap: 15px">
                <div class="col-md-3">
                    <abp-input asp-for="MembershipTier.DisplayOrder" />
                </div>
                <div class="col-md-3 isActive">
                    <abp-input asp-for="MembershipTier.IsActive" />
                </div>
            </div>
        </abp-modal-body>
        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<style type="text/css">
    .modal-dialog {
        max-width: 30%;
    }

    .isActive {
        display: flex;
        align-items: center;
    }
</style>

<script>
    (function () {
        const MONEY_SELECTOR = 'input[name="MembershipTier.MinTotalSpending"]';
        const WARN_MSG = 'Chỉ được nhập số (0-9) cho Doanh thu tối thiểu (VND).';

        function digitsOnly(str) {
            return (str || '').replace(/\D+/g, '');
        }

        function formatVND(digits) {
            if (!digits) return '';
            digits = digits.replace(/^0+(?=\d)/, '');
            return digits.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function showWarnOnce(input, msg) {
            const now = Date.now();
            const last = Number(input.dataset.lastWarnAt || 0);
            if (now - last < 800) return;
            input.dataset.lastWarnAt = String(now);

            if (window.abp?.notify?.warn) abp.notify.warn(msg);
            else alert(msg);
        }

        const input = document.querySelector(MONEY_SELECTOR);
        if (!input) return;

        input.value = formatVND(digitsOnly(input.value));

        input.addEventListener('focus', function () {
            input.dataset.hadInvalid = '0';
            input.value = digitsOnly(input.value);
        });

        input.addEventListener('input', function () {
            const raw = input.value;
            const cleaned = digitsOnly(raw);

            if (raw !== cleaned) {
                input.dataset.hadInvalid = '1';
                input.value = cleaned;
            }
        });

        input.addEventListener('blur', function () {
            const rawDigits = digitsOnly(input.value);

            if (input.dataset.hadInvalid === '1') {
                showWarnOnce(input, WARN_MSG);
            }

            input.value = formatVND(rawDigits);
            input.dataset.hadInvalid = '0';
        });

        const form = input.closest('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                const digits = digitsOnly(input.value);
                if (input.value !== digits) {
                    input.value = digits;
                }
                input.value = digits;
            });
        }
    })();
</script>
