@page
@using Genora.MultiTenancy.Localization
@using Genora.MultiTenancy.Web.Pages.AppCustomers
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model EditModalModel
@inject IStringLocalizer<MultiTenancyResource> L
@{
    Layout = null;

    var dobText = Model.Customer?.DateOfBirth.HasValue == true
        ? Model.Customer.DateOfBirth.Value.ToString("dd/MM/yyyy")
        : string.Empty;

    var avatarUrl = (Model.Customer?.AvatarUrl ?? "").Trim();
    var hasAvatar = !string.IsNullOrWhiteSpace(avatarUrl);

    var fullName = (Model.Customer?.FullName ?? "").Trim();
    string initials = "KH";
    if (!string.IsNullOrWhiteSpace(fullName))
    {
        var parts = fullName
            .Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .ToList();

        if (parts.Count == 1) initials = parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpperInvariant();
        else
        {
            var first = parts.First()[0].ToString();
            var last = parts.Last()[0].ToString();
            initials = (first + last).ToUpperInvariant();
        }
    }

    var isFollower = Model.Customer?.IsFollower == true;
}

<form asp-page="/AppCustomers/EditModal" method="post" id="EditCustomerForm">
    <abp-modal>
        <abp-modal-header title="@L["EditAppCustomer"]"></abp-modal-header>

        <abp-modal-body>
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="Customer.CustomerCode" />
            <input type="hidden" asp-for="Customer.AvatarUrl" />

            <div class="row g-3 align-items-center mb-1">
                <div class="col-md-12">
                    <div class="customer-avatar-line">
                        <div class="avatar-thumb">
                            @if (hasAvatar)
                            {
                                <img src="@avatarUrl" alt="avatar" />
                            }
                            else
                            {
                                <div class="avatar-initials">@initials</div>
                            }
                        </div>
                        <div class="avatar-meta">
                            <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(fullName) ? fullName : "Khách hàng")</div>
                            <div class="text-muted small">Avatar tự đồng bộ từ Zalo profile (nếu có)</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-3">
                    <abp-input asp-for="Customer.CustomerCode"
                               label="@L["CustomerCode"]"
                               readonly="true"
                               class="readonly-gray" />
                </div>
                <div class="col-md-5">
                    <abp-input asp-for="Customer.FullName"
                               label="@L["CustomerFullName"]"
                               placeholder="Nguyễn Văn A" />
                </div>
                <div class="col-md-4">
                    <abp-input asp-for="Customer.PhoneNumber"
                               label="@L["CustomerPhoneNumber"]"
                               placeholder="0912345678" />
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="Customer.DateOfBirth" class="form-label">@L["DateOfBirth"]</label>
                    <input asp-for="Customer.DateOfBirth"
                           type="text"
                           class="form-control dob-input"
                           value="@dobText"
                           placeholder="01/01/1980"
                           autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <abp-select asp-for="Customer.Gender"
                                asp-items="Model.GenderItems"
                                label="@L["Gender"]" />
                </div>
                <div class="col-md-6">
                    <abp-input asp-for="Customer.Email"
                               label="@L["Email"]"
                               placeholder="abc@xyz.com" />
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-12">
                    <abp-input asp-for="Customer.Address"
                               label="@L["Address"]"
                               type="text"
                               placeholder="Đường A, phường B, thành phố D,..." />
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <abp-select asp-for="Customer.ProvinceCode"
                                asp-items="Model.ProvinceItems"
                                label="Tỉnh / Thành phố" />
                </div>
                <div class="col-md-4">
                    <abp-select asp-for="Customer.CustomerTypeId"
                                asp-items="Model.CustomerTypeItems"
                                label="@L["CustomerType"]" />
                </div>
                <div class="col-md-4">
                    <abp-input asp-for="Customer.VgaCode"
                               label="@L["VgaCode"]"
                               type="text"
                               placeholder="ABC12345" />
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <abp-input asp-for="Customer.ZaloUserId"
                               label="@L["ZaloUserId"]"
                               placeholder="1234567890" />
                </div>
                <div class="col-md-4">
                    <div class="form-check mt-4 pt-1">
                        <input class="form-check-input"
                               type="checkbox"
                               disabled
                               @(isFollower ? "checked" : "") />
                        <label class="form-check-label">
                            @(isFollower ? "Đã quan tâm Zalo OA" : "Chưa quan tâm Zalo OA")
                        </label>
                        <input type="hidden" name="Customer.IsFollower" value="@(isFollower ? "true" : "false")" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mt-4 pt-1">
                        <abp-input asp-for="Customer.IsActive" label="Được hoạt động" />
                    </div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <abp-input asp-for="Customer.MembershipTierName"
                               label="@L["MembershipTier"]"
                               type="text" readonly="true" class="readonly-gray" />
                </div>
                <div class="col-md-6">
                    <abp-input asp-for="Customer.BonusPoint"
                               label="@L["BonusPoint"]"
                               type="number" readonly="true" class="readonly-gray" />
                </div>
            </div>

        </abp-modal-body>

        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<style type="text/css">
    .modal-dialog {
        max-width: 55%;
    }

    .readonly-gray input[readonly] {
        background: #e0e0e0 !important;
        color: #555 !important;
        font-weight: 600;
        cursor: not-allowed;
    }

    .customer-avatar-line {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border: 1px solid #eee;
        border-radius: 10px;
        background: #fafafa;
    }

    .avatar-thumb {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid #e6e6e6;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 42px;
    }

        .avatar-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .avatar-initials {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #fff;
        background: #6c757d;
        letter-spacing: .5px;
    }
</style>
