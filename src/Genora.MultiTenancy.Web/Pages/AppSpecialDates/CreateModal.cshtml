@page
@using Genora.MultiTenancy.Localization
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model Genora.MultiTenancy.Web.Pages.AppSpecialDates.CreateModalModel
@inject IStringLocalizer<MultiTenancyResource> L
@{
    Layout = null;
}

<form id="SpecialDateCreateForm" abp-model="SpecialDate" asp-page="/AppSpecialDates/CreateModal">
    <abp-modal>
        <abp-modal-header title="@L["NewSpecialDate"].Value"></abp-modal-header>

        <abp-modal-body>
            <div class="mb-3">
                <label class="form-label">@L["Name"]</label>
                <input class="form-control"
                       asp-for="SpecialDate.Name"
                       id="NameInput"
                       placeholder="Nhập: Ngày trong tuần / Ngày cuối tuần / Ngày lễ" />
                <span class="text-danger" asp-validation-for="SpecialDate.Name"></span>
            </div>

            <abp-input asp-for="SpecialDate.Description" label="@L["Description"]" />
            <abp-select asp-for="SpecialDate.GolfCourseId"
                        asp-items="Model.GolfCourseItems"
                        label="@L["GolfCourse"]">
            </abp-select>
            <abp-input asp-for="SpecialDate.IsActive" label="@L["IsActive"]" />

            <!-- NEW: Weekdays block -->
            <div class="mb-3" id="WeekdaysBlock" style="display:none">
                <label class="form-label">Áp dụng cho</label>

                <div class="border rounded p-3 bg-light">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="AllWeekdaysChk" checked>
                        <label class="form-check-label fw-semibold" for="AllWeekdaysChk">Tất cả các thứ trong tuần</label>
                    </div>

                    <div class="d-flex flex-wrap gap-2" id="WeekdaysChecks">
                        @{
                            // DayOfWeek: 0=CN,1=T2,...,6=T7
                            var items = new (int Value, string Label)[] {
                                                (1,"Thứ 2"), (2,"Thứ 3"), (3,"Thứ 4"), (4,"Thứ 5"), (5,"Thứ 6"), (6,"Thứ 7"), (0,"Chủ nhật")
                                                };

                            foreach (var it in items)
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input wd" type="checkbox" id="Wd_@it.Value" value="@it.Value" checked>
                                    <label class="form-check-label" for="Wd_@it.Value">@it.Label</label>
                                </div>
                            }
                        }
                    </div>

                    <small class="text-muted d-block mt-2">
                        Chỉ áp dụng khi Name khác "Ngày lễ".
                    </small>
                </div>
            </div>

            <div class="mb-3" id="DatesBlock" style="display:none">
                <label class="form-label">@L["Dates"]</label>
                <textarea class="form-control" id="DatesTextarea" rows="8"
                          placeholder="Mỗi dòng 1 ngày dd/MM/yyyy"></textarea>
                <small class="text-muted">Chỉ áp dụng khi Name = "Ngày lễ".</small>
            </div>
        </abp-modal-body>

        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<script>
    (function () {
        var form = document.getElementById('SpecialDateCreateForm');
        var nameInput = document.getElementById('NameInput');

        var datesBlock = document.getElementById('DatesBlock');
        var datesTextarea = document.getElementById('DatesTextarea');

        var weekdaysBlock = document.getElementById('WeekdaysBlock');
        var allChk = document.getElementById('AllWeekdaysChk');
        var wdChecks = Array.from(document.querySelectorAll('#WeekdaysChecks input.wd'));

        function normalizeName(x) {
            x = (x || '').trim();
            if (x.toLowerCase() === 'ngày trong tuần') return 'Ngày trong tuần';
            if (x.toLowerCase() === 'ngày cuối tuần') return 'Ngày cuối tuần';
            if (x.toLowerCase() === 'ngày lễ' || x.toLowerCase() === 'ngay le') return 'Ngày lễ';
            return x;
        }

        function isHoliday() {
            return normalizeName(nameInput.value) === 'Ngày lễ';
        }

        function toggleBlocks() {
            var name = normalizeName(nameInput.value);
            datesBlock.style.display = (name === 'Ngày lễ') ? 'block' : 'none';
            weekdaysBlock.style.display = (name === 'Ngày lễ') ? 'none' : 'block';
        }

        function setAllMode(on) {
            if (on) {
                wdChecks.forEach(function (c) {
                    c.checked = true;
                    c.disabled = true;
                });
            } else {
                wdChecks.forEach(function (c) {
                    c.disabled = false;
                });
            }
        }

        function parseDdMMyyyy(s) {
            s = (s || '').trim();
            if (!s) return null;
            var m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (!m) return null;

            var dd = parseInt(m[1], 10);
            var mm = parseInt(m[2], 10);
            var yy = parseInt(m[3], 10);

            var d = new Date(yy, mm - 1, dd);
            if (d.getFullYear() !== yy || (d.getMonth() + 1) !== mm || d.getDate() !== dd) return null;

            return yy + '-' + String(mm).padStart(2, '0') + '-' + String(dd).padStart(2, '0');
        }

        // INIT
        nameInput.value = normalizeName(nameInput.value);
        toggleBlocks();
        setAllMode(true);

        nameInput.addEventListener('input', function () {
            nameInput.value = normalizeName(nameInput.value);
            toggleBlocks();
        });

        allChk.addEventListener('change', function () {
            setAllMode(allChk.checked);
        });

        // nếu user tick/bỏ tick từng thứ -> auto tắt "Tất cả"
        wdChecks.forEach(function (c) {
            c.addEventListener('change', function () {
                if (c.disabled) return;
                if (!c.checked) {
                    allChk.checked = false;
                    setAllMode(false);
                }
            });
        });

        form.addEventListener('submit', function (e) {
            // remove old dynamic inputs
            form.querySelectorAll('input[name="SpecialDate.Dates"]').forEach(function (x) { x.remove(); });
            form.querySelectorAll('input[name="SpecialDate.Weekdays"]').forEach(function (x) { x.remove(); });

            var name = normalizeName(nameInput.value);

            // Holiday: build SpecialDate.Dates
            if (name === 'Ngày lễ') {
                var text = datesTextarea.value || '';
                var lines = text.split(/\r?\n/).map(function (x) { return x.trim(); }).filter(Boolean);

                for (var i = 0; i < lines.length; i++) {
                    var iso = parseDdMMyyyy(lines[i]);
                    if (!iso) {
                        if (window.abp?.notify?.error) abp.notify.error("Ngày không hợp lệ ở dòng " + (i + 1) + ": " + lines[i]);
                        e.preventDefault();
                        return;
                    }

                    var inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'SpecialDate.Dates';
                    inp.value = iso;
                    form.appendChild(inp);
                }

                return;
            }

            // Non-holiday: build SpecialDate.Weekdays (0..6). All => 0..6
            var selected = [];
            if (allChk.checked) {
                selected = [1,2,3,4,5,6,0]; // Mon..Sat + Sun(0)
            } else {
                selected = wdChecks.filter(function (x) { return x.checked; })
                                    .map(function (x) { return parseInt(x.value, 10); });
                if (!selected.length) selected = [1,2,3,4,5,6,0];
            }

            selected.forEach(function (v) {
                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'SpecialDate.Weekdays';
                inp.value = String(v);
                form.appendChild(inp);
            });
        });
    })();
</script>
