@page
@using Genora.MultiTenancy.Localization
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model Genora.MultiTenancy.Web.Pages.AppSpecialDates.CreateModalModel
@inject IStringLocalizer<MultiTenancyResource> L
@{
    Layout = null;
}

<form id="SpecialDateCreateForm" abp-model="SpecialDate" asp-page="/AppSpecialDates/CreateModal">
    <abp-modal>
        <abp-modal-header title="@L["NewSpecialDate"].Value"></abp-modal-header>

        <abp-modal-body>
            <div class="mb-3">
                <label class="form-label">@L["Name"]</label>
                <input class="form-control"
                       asp-for="SpecialDate.Name"
                       id="NameInput"
                       placeholder="Nhập: Ngày trong tuần / Ngày cuối tuần / Ngày lễ" />
                <span class="text-danger" asp-validation-for="SpecialDate.Name"></span>
            </div>

            <abp-input asp-for="SpecialDate.Description" label="@L["Description"]" />
            <abp-select asp-for="SpecialDate.GolfCourseId"
                        asp-items="Model.GolfCourseItems"
                        label="@L["GolfCourse"]">
            </abp-select>
            <abp-input asp-for="SpecialDate.IsActive" label="@L["IsActive"]" />

            <div class="mb-3" id="DatesBlock" style="display:none">
                <label class="form-label">@L["Dates"]</label>
                <textarea class="form-control" id="DatesTextarea" rows="8"
                          placeholder="Mỗi dòng 1 ngày dd/MM/yyyy"></textarea>
                <small class="text-muted">Chỉ áp dụng khi Name = "Ngày lễ".</small>
            </div>
        </abp-modal-body>

        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<script>
    (function () {
        var form = document.getElementById('SpecialDateCreateForm');
        var nameInput = document.getElementById('NameInput');
        var datesBlock = document.getElementById('DatesBlock');
        var datesTextarea = document.getElementById('DatesTextarea');

        function normalizeName(x) {
            x = (x || '').trim();
            if (x.toLowerCase() === 'ngày trong tuần') return 'Ngày trong tuần';
            if (x.toLowerCase() === 'ngày cuối tuần') return 'Ngày cuối tuần';
            if (x.toLowerCase() === 'ngày lễ' || x.toLowerCase() === 'ngay le') return 'Ngày lễ';
            return x;
        }

        function toggleDates() {
            var name = normalizeName(nameInput.value);
            datesBlock.style.display = (name === 'Ngày lễ') ? 'block' : 'none';
        }

        function parseDdMMyyyy(s) {
            s = (s || '').trim();
            if (!s) return null;
            var m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (!m) return null;

            var dd = parseInt(m[1], 10);
            var mm = parseInt(m[2], 10);
            var yy = parseInt(m[3], 10);

            var d = new Date(yy, mm - 1, dd);
            if (d.getFullYear() !== yy || (d.getMonth() + 1) !== mm || d.getDate() !== dd) return null;

            return yy + '-' + String(mm).padStart(2, '0') + '-' + String(dd).padStart(2, '0');
        }

        // INIT
        nameInput.value = normalizeName(nameInput.value);
        toggleDates();

        nameInput.addEventListener('input', function () {
            nameInput.value = normalizeName(nameInput.value);
            toggleDates();
        });

        form.addEventListener('submit', function (e) {
            // remove old dynamic inputs
            var old = form.querySelectorAll('input[name="SpecialDate.Dates"]');
            old.forEach(function (x) { x.remove(); });

            var name = normalizeName(nameInput.value);
            if (name !== 'Ngày lễ') return;

            var text = datesTextarea.value || '';
            var lines = text.split(/\r?\n/).map(function (x) { return x.trim(); }).filter(Boolean);

            for (var i = 0; i < lines.length; i++) {
                var iso = parseDdMMyyyy(lines[i]);
                if (!iso) {
                    if (window.abp?.notify?.error) abp.notify.error("Ngày không hợp lệ ở dòng " + (i + 1) + ": " + lines[i]);
                    e.preventDefault();
                    return;
                }

                var inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = 'SpecialDate.Dates';
                inp.value = iso;
                form.appendChild(inp);
            }
        });
    })();
</script>
