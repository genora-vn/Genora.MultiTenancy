@page
@using Genora.MultiTenancy.Localization
@using Genora.MultiTenancy.Web.Pages.AppSettings
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model EditModalModel
@inject IStringLocalizer<MultiTenancyResource> L
@{
    Layout = null;
}
<form abp-model="AppSetting" asp-page="/AppSettings/EditModal" enctype="multipart/form-data">
    <abp-modal>
        <abp-modal-header title="@L["UpdateAppsetting"].Value"></abp-modal-header>
        <abp-modal-body>
            <abp-input asp-for="Id" />
            <abp-input asp-for="AppSetting.SettingKey" type="hidden" />

            <abp-input asp-for="AppSetting.SettingKey"
                       placeholder="Nhập mã cấu hình (vd: color_background, logo_image,..)"
                       label="@L["SettingKey"]" disabled="true" />

            <abp-input asp-for="AppSetting.IsImageInput" id="IsImageInput" label="@L["IsImageInput"]" />

            <abp-input asp-for="AppSetting.SettingType" id="setting-type"
                       placeholder="Nhập loại cấu hình" label="@L["SettingType"]" />

            <div class="group" id="input-value">
                <abp-input asp-for="AppSetting.SettingValue"
                           placeholder="Nhập giá trị cấu hình (vd: #FFFFF,https://example.com/logo.img,...)"
                           label="@L["SettingValue"]" />
            </div>

            <div class="mb-3" style="display:none" id="input-image">
                <div class="image-upload-group">
                    <label for="images" class="form-label mb-1">
                        Tải ảnh:
                        <small class="text-muted d-block">
                            Tối đa <span id="maxFileSizeLabel"></span>/ảnh. Định dạng: JPG/PNG/WebP.
                        </small>
                    </label>

                    <div class="drop-zone" id="dropZone">
                        <p class="mb-0">Kéo thả ảnh vào đây hoặc click để chọn</p>
                        <input asp-for="AppSetting.Images" type="file" id="images" accept="image/*" multiple style="display:none;">
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="preview-grid" id="previewGrid"></div>
            </div>

            <div class="mb-3">
                <label asp-for="AppSetting.Description" class="form-label">@L["Description"]</label>
                <textarea asp-for="AppSetting.Description"
                          class="form-control"
                          placeholder="Mô tả cấu hình"
                          rows="4"></textarea>
            </div>

            <abp-input asp-for="AppSetting.IsActive" placeholder="Nhập mã cấu hình" label="@L["IsActive"]" />
        </abp-modal-body>
        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<style type="text/css">
    .image-upload-group {
        margin: 20px 0;
    }

    .drop-zone {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
        background-color: #f9f9f9;
    }

        .drop-zone:hover {
            border-color: #999;
        }

        .drop-zone.drag-over {
            border-color: #007bff;
            background-color: #e9f7ff;
        }

    .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .preview-item {
        position: relative;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

        .preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

    .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255,0,0,0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-size: 16px;
        line-height: 25px;
        padding: 0;
    }
</style>

<script>
    (function () {
        const MAX_FILE_MB = 15;
        const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

        // ✅ helper: lấy đúng checkbox ABP render (có thể là hidden + checkbox)
        function findIsImageCheckbox(form) {
            // Ưu tiên theo name (ABP thường render đúng name)
            return form.querySelector('input[type="checkbox"][name="AppSetting.IsImageInput"]')
                || form.querySelector('input[type="checkbox"][name$=".IsImageInput"]')
                // fallback theo id (nếu may mắn ABP gán id vào input)
                || form.querySelector('#IsImageInput[type="checkbox"]')
                // fallback cuối: tìm trong wrapper có id IsImageInput (ABP có thể gắn id lên container)
                || form.querySelector('#IsImageInput input[type="checkbox"]');
        }

        function setMode(form, isImage) {
            const inputValue = form.querySelector('#input-value');
            const inputImage = form.querySelector('#input-image');
            const valueType  = form.querySelector('#setting-type');

            if (isImage) {
                if (inputValue) inputValue.style.display = 'none';
                if (inputImage) inputImage.style.display = 'block';
                if (valueType) valueType.value = 'image';
            } else {
                if (inputValue) inputValue.style.display = 'block';
                if (inputImage) inputImage.style.display = 'none';
            }
        }

        // ✅ delegation: luôn bắt được change dù modal inject/replace
        document.addEventListener('change', function (e) {
            const t = e.target;
            if (!t) return;

            // chỉ xử lý checkbox đúng tên
            const isTarget = (t.matches && (
                t.matches('input[type="checkbox"][name="AppSetting.IsImageInput"]') ||
                t.matches('input[type="checkbox"][name$=".IsImageInput"]') ||
                t.matches('#IsImageInput[type="checkbox"]')
            ));
            if (!isTarget) return;

            const form = t.closest('form');
            if (!form) return;

            setMode(form, t.checked);
        });

        // ✅ init sau khi modal đã render
        setTimeout(function () {
            // tìm form edit trong DOM (modal)
            const form =
                document.querySelector('form[asp-page="/AppSettings/EditModal"], form[action*="/AppSettings/EditModal"]')
                || document.querySelector('form');

            if (!form) return;

            // tránh init nhiều lần
            if (form.dataset.imageUploadInit === "1") return;
            form.dataset.imageUploadInit = "1";

            const maxFileSizeLabel = form.querySelector('#maxFileSizeLabel');
            if (maxFileSizeLabel) maxFileSizeLabel.textContent = `${MAX_FILE_MB}MB`;

            const fileInput = form.querySelector('#images');
            const dropZone = form.querySelector('#dropZone');
            const previewGrid = form.querySelector('#previewGrid');
            if (!fileInput || !dropZone || !previewGrid) return;

            let selectedFiles = [];

            function notifySizeError(file) {
                const mb = (file.size / (1024 * 1024)).toFixed(2);
                const msg = `"${file.name}" (${mb}MB) vượt quá ${MAX_FILE_MB}MB/ảnh. Vui lòng chọn ảnh nhỏ hơn.`;
                if (window.abp?.notify?.warn) abp.notify.warn(msg);
                else alert(msg);
            }

            function updateFileInput() {
                const dt = new DataTransfer();
                selectedFiles.forEach(f => dt.items.add(f));
                fileInput.files = dt.files;
            }

            function createPreview(src, name, isExistingUrl) {
                // tránh add trùng preview nếu mở modal nhiều lần
                const safeName = (window.CSS && CSS.escape) ? CSS.escape(name) : name.replace(/"/g, '\\"');
                if (previewGrid.querySelector(`[data-filename="${safeName}"]`)) return;

                const item = document.createElement('div');
                item.className = 'preview-item';
                item.dataset.filename = name;

                const img = document.createElement('img');
                img.src = src;
                img.alt = name;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.textContent = '×';
                removeBtn.className = 'remove-btn';
                removeBtn.onclick = () => {
                    selectedFiles = selectedFiles.filter(f => f.name !== name);

                    if (isExistingUrl) {
                        const settingValueInput = form.querySelector('[name="AppSetting.SettingValue"]');
                        if (settingValueInput) settingValueInput.value = '';
                    }

                    item.remove();
                    updateFileInput();
                };

                item.appendChild(img);
                item.appendChild(removeBtn);
                previewGrid.appendChild(item);
            }

            function handleFiles(files) {
                for (let file of files) {
                    if (!file.type || !file.type.startsWith('image/')) continue;

                    if (file.size > MAX_FILE_BYTES) {
                        notifySizeError(file);
                        continue;
                    }

                    if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        continue;
                    }

                    selectedFiles.push(file);

                    const reader = new FileReader();
                    reader.onload = (e) => createPreview(e.target.result, file.name, false);
                    reader.readAsDataURL(file);
                }
                updateFileInput();
            }

            // init mode theo model (server)
            const settingType = "@(Model.AppSetting?.SettingType ?? "")";
            const settingValue = "@(Model.AppSetting?.SettingValue ?? "")";

            const chk = findIsImageCheckbox(form);

            if (settingType === "image") {
                if (chk) chk.checked = true;
                setMode(form, true);

                if (settingValue) {
                    try {
                        const filename = settingValue.split('/').pop() || "image";
                        createPreview(settingValue, filename, true);
                    } catch { }
                }
            } else {
                // đảm bảo đúng trạng thái ban đầu
                if (chk) setMode(form, chk.checked);
            }

            // upload handlers
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files?.length) handleFiles(fileInput.files);
            });

            // nếu ABP checkbox đã render nhưng setMode chưa chạy do timing, bắn change giả
            if (chk) chk.dispatchEvent(new Event('change', { bubbles: true }));
        }, 0);
    })();
</script>
