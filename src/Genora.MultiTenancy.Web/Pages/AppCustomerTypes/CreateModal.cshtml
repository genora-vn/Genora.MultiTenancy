@page
@using Genora.MultiTenancy.Localization
@using Genora.MultiTenancy.Web.Pages.AppCustomerTypes
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model CreateModalModel
@inject IStringLocalizer<MultiTenancyResource> L
@{
    Layout = null;
}
<form abp-model="CustomerType" asp-page="/AppCustomerTypes/CreateModal">
    <abp-modal>
        <abp-modal-header title="@L["CreateAppCustomerType"].Value"></abp-modal-header>
        <abp-modal-body>
            @* <abp-form-content /> *@
            <abp-input asp-for="CustomerType.Code" placeholder="Nhập mã code loại khách hàng" label="@L["CustomerTypeCode"]" />
            <abp-input asp-for="CustomerType.Name" placeholder="Nhập tên loại khách hàng" label="@L["CustomerTypeName"]" />
            <div class="mb-3">
                <label asp-for="CustomerType.Description" class="form-label">@L["Description"]</label>
                <textarea asp-for="CustomerType.Description" class="form-control" rows="3" placeholder="Mô tả loại khách hàng"></textarea>
                <span asp-validation-for="CustomerType.Description" class="text-danger"></span>
            </div>
            <div style="display: inline-flex; width: 100%">
                <label asp-for="CustomerType.ColorCode" class="form-label" style="width: 18%">@L["ColorCode"]</label>

                <input asp-for="CustomerType.ColorCode"
                       type="text"
                       id="color-code"
                       class="form-control"
                       placeholder="#RRGGBB"
                       autocomplete="off" />

                <input id="color-picker" type="color" class="form-control color-input" />

            </div>
            <span asp-validation-for="CustomerType.ColorCode" class="text-danger"></span>

            <div class="mt-2">
                <abp-input asp-for="CustomerType.IsActive" label="@L["IsActive"]" />
            </div>
        </abp-modal-body>
        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<style type="text/css">
    .color-input {
        width: 45px;
        height: 47px;
        padding: 8px;
        margin-left: 0;
        border-radius: 0 0.5rem 0.5rem 0;
    }

    #color-code{
        border-radius: 0.5rem 0 0 0.5rem;
        margin-left: 20px;
        width: 68%;
        padding-right: 0
    }
</style>
<script>
    $(document).ready(function () {
        var $form = $('form[abp-model="CustomerType"]');
        var $desc = $form.find('[name="CustomerType.Description"]');
        var $colorCode = $form.find('[name="CustomerType.ColorCode"]');
        var $picker = $('#color-picker');

        function refreshValidation() {
            $form.removeData('validator');
            $form.removeData('unobtrusiveValidation');
            if ($.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse($form);
            }
        }

        $desc.removeAttr('required')
             .removeAttr('data-val-required');

        refreshValidation();

        if ($.validator) {
            if (!$.validator.methods.regex) {
                $.validator.addMethod("regex", function (value, element, pattern) {
                    if (this.optional(element)) return true;
                    return pattern.test(value);
                });
            }
        }

        function normalizeHex(val) {
            val = (val || "").trim();
            if (!val) return "";
            if (!val.startsWith("#")) val = "#" + val;

            if (/^#([0-9a-fA-F]{3})$/.test(val)) {
                var r = val[1], g = val[2], b = val[3];
                val = "#" + r + r + g + g + b + b;
            }
            return val;
        }

        function isValidHex6(val) {
            return /^#([0-9a-fA-F]{6})$/.test(val);
        }

        if ($colorCode.length && $colorCode.rules) {
            $colorCode.rules('remove');
            $colorCode.rules('add', {
                required: true,
                regex: /^#([0-9a-fA-F]{6})$/,
                messages: {
                    required: "Vui lòng nhập mã màu.",
                    regex: "Mã màu phải đúng định dạng #RRGGBB (vd: #FF6600)."
                }
            });
        }

        $picker.on('input', function () {
            var selected = $(this).val();
            $colorCode.val(selected).trigger('change');
        });

        $colorCode.on('input', function () {
            var val = normalizeHex($(this).val());
            $(this).val(val);

            if (isValidHex6(val)) {
                $picker.val(val);
            }
        });

        $form.on('submit', function () {
            var val = normalizeHex($colorCode.val());
            $colorCode.val(val);

            if ($form.valid && !$form.valid()) {
                return false;
            }
            return true;
        });

        var initVal = normalizeHex($colorCode.val());
        $colorCode.val(initVal);
        if (isValidHex6(initVal)) $picker.val(initVal);
    });
</script>
