@page
@using Genora.MultiTenancy.Enums
@using Genora.MultiTenancy.Localization
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model Genora.MultiTenancy.Web.Pages.AppCalendarSlots.DetailModalModel
@inject IStringLocalizer<MultiTenancyResource> L

@{
    Layout = null;

    var isEdit = Model.Id.HasValue;

    var fromText = Model.Slot?.TimeFrom.ToString(@"hh\:mm") ?? "";
    var toText = Model.Slot?.TimeTo.ToString(@"hh\:mm") ?? "";

    var applyDateIso = Model.Slot?.ApplyDate.ToString("yyyy-MM-dd") ?? "";
}

<form asp-page="/AppCalendarSlots/DetailModal" method="post" id="SlotDetailForm">
    <abp-modal>
        <abp-modal-header title="@(isEdit? L["EditCalendarSlot"] : L["CreateCalendarSlot"])"></abp-modal-header>

        <abp-modal-body>
            @if (isEdit)
            {
                <input type="hidden" asp-for="Id" />
            }
            <input type="hidden" asp-for="Slot.GolfCourseId" />
            <abp-row>
                <abp-column size-md="_4">
                    <div class="mb-3">
                        <label class="form-label">Ngày chơi</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa-regular fa-calendar"></i></span>
                            <input name="Slot.ApplyDate"
                                   id="Slot_ApplyDate"
                                   class="form-control calendar-date-input"
                                   type="text"
                                   autocomplete="off"
                                   value="@applyDateIso"
                                   tabindex="1" />
                        </div>
                    </div>
                </abp-column>

                <abp-column size-md="_4">
                    <div class="mb-3">
                        <label class="form-label">@L["TimeFrom"]</label>
                        <input name="Slot.TimeFrom"
                               id="Slot_TimeFrom"
                               type="text"
                               class="form-control time-input"
                               value="@fromText"
                               autocomplete="off"
                               @(isEdit ? "readonly" : "") tabindex="2" />
                    </div>
                </abp-column>

                <abp-column size-md="_4">
                    <div class="mb-3">
                        <label class="form-label">@L["TimeTo"]</label>
                        <input name="Slot.TimeTo"
                               id="Slot_TimeTo"
                               type="text"
                               class="form-control time-input"
                               value="@toText"
                               autocomplete="off"
                               @(isEdit ? "readonly" : "") tabindex="3" />
                    </div>
                </abp-column>
            </abp-row>
            <abp-row>
                <abp-column size-md="_6">
                    <abp-select asp-for="Slot.PromotionTypeId"
                                label="@L["PromotionType"]"
                                asp-items="@Model.Promotions" tabindex="4" />
                </abp-column>

                <abp-column size-md="_6">
                    <abp-input asp-for="Slot.MaxSlots" label="@L["MaxSlots"]" tabindex="5" />
                </abp-column>
            </abp-row>

            <div class="mb-2">
                <label class="form-label" asp-for="Slot.InternalNote">@L["InternalNote"]</label>
                <textarea asp-for="Slot.InternalNote"
                          placeholder="Nhập ghi chú"
                          class="form-control"
                          rows="2" tabindex="6"></textarea>
            </div>

            <div class="mb-2">
                <abp-input asp-for="Slot.IsActive" label="Được sử dụng" tabindex="7" />
            </div>

            <div style="display:inline-flex; margin-top: 14px; width: 100%">
                <h5 style="margin-top:13px">@L["CalendarSlotPrices"]</h5>
                <hr style="width: 85%" />
            </div>

            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th style="min-width:220px">@L["CustomerType"]</th>
                            <th class="text-end" style="min-width:140px">Giá 9 hố</th>
                            <th class="text-end" style="min-width:140px">Giá 18 hố</th>
                            <th class="text-end" style="min-width:140px">Giá 27 hố</th>
                            <th class="text-end" style="min-width:140px">Giá 36 hố</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < (Model.Slot?.Prices?.Count ?? 0); i++)
                        {
                            var row = Model.Slot.Prices[i];
                            <tr>
                                <td>
                                    <input type="hidden" name="Slot.Prices[@i].CustomerTypeId" value="@row.CustomerTypeId" />
                                    <select class="form-select" disabled>
                                        @foreach (var opt in Model.CustomerTypeItems)
                                        {
                                            var selected = opt.Value == row.CustomerTypeId.ToString();
                                            <option value="@opt.Value" selected="@(selected ? "selected" : null)">@opt.Text</option>
                                        }
                                    </select>
                                </td>

                                <td>
                                    <input name="Slot.Prices[@i].Price9"
                                           type="text"
                                           class="form-control money-input text-end"
                                           value="@(row.Price9.HasValue? row.Price9.Value.ToString("0") : "")"
                                           inputmode="numeric"
                                           autocomplete="off" />
                                </td>

                                <td>
                                    <div class="money-cell">
                                        <input name="Slot.Prices[@i].Price18"
                                               type="text"
                                               class="form-control money-input text-end money-required-18"
                                               value="@(row.Price18 > 0 ? row.Price18.ToString("0") : "")"
                                               inputmode="numeric"
                                               autocomplete="off" />
                                        <div class="invalid-feedback">Giá 18 hố bắt buộc và phải &gt; 0</div>
                                    </div>
                                </td>

                                <td>
                                    <input name="Slot.Prices[@i].Price27"
                                           type="text"
                                           class="form-control money-input text-end"
                                           value="@(row.Price27.HasValue? row.Price27.Value.ToString("0") : "")"
                                           inputmode="numeric"
                                           autocomplete="off" />
                                </td>

                                <td>
                                    <input name="Slot.Prices[@i].Price36"
                                           type="text"
                                           class="form-control money-input text-end"
                                           value="@(row.Price36.HasValue? row.Price36.Value.ToString("0") : "")"
                                           inputmode="numeric"
                                           autocomplete="off" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </abp-modal-body>

        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>

<style type="text/css">
    .modal-dialog {
        max-width: 50%;
    }

    .money-input.is-invalid + .invalid-feedback {
        display: block;
    }

    .money-cell {
        position: relative;
    }

    .money-cell {
        position: relative;
    }
</style>

<script>
    (function () {
        // ===== Date picker (Flatpickr) =====
        function initDatePicker() {
            if (!window.flatpickr) return;
            var el = document.getElementById('Slot_ApplyDate');
            if (!el) return;

            flatpickr(el, {
                dateFormat: "Y-m-d",
                allowInput: false,
                clickOpens: true
            });
        }

        // ===== Time picker (Flatpickr) =====
        function initTimePicker() {
            if (!window.flatpickr) return;

            ['Slot_TimeFrom', 'Slot_TimeTo'].forEach(function (id) {
                var el = document.getElementById(id);
                if (!el) return;

                flatpickr(el, {
                    enableTime: true,
                    noCalendar: true,
                    time_24hr: true,
                    dateFormat: "H:i",
                    allowInput: true,
                    clickOpens: true
                });
            });
        }

        // ===== Money helpers vi-VN =====
        function normalizeMoney(raw) {
            if (!raw) return '';
            return String(raw).replace(/[^\d]/g, '');
        }

        function formatMoneyVN(raw) {
            var n = parseInt(normalizeMoney(raw), 10);
            if (isNaN(n)) return '';
            return n.toLocaleString('vi-VN');
        }

        function parseMoney(raw) {
            var n = parseInt(normalizeMoney(raw), 10);
            return isNaN(n) ? null : n;
        }

        function setInvalid(el) { el.classList.add('is-invalid'); }
        function clearInvalid(el) { el.classList.remove('is-invalid'); }

        // Validate only Price18 on blur
        function validatePrice18Field(el) {
            var n = parseMoney(el.value);
            if (n === null || n <= 0) {
                setInvalid(el);
                return false;
            }
            clearInvalid(el);
            return true;
        }

        // Validate all Price18 trước submit
        function validateAllPrice18() {
            var ok = true;
            document.querySelectorAll('.money-required-18').forEach(function (el) {
                if (!validatePrice18Field(el)) ok = false;
            });
            return ok;
        }

        function initMoney() {
            document.querySelectorAll('.money-input').forEach(function (el) {
                // format lúc load
                el.value = formatMoneyVN(el.value);

                el.addEventListener('focus', function () {
                    el.value = normalizeMoney(el.value);
                });

                el.addEventListener('input', function () {
                    el.value = normalizeMoney(el.value);
                    if (el.classList.contains('money-required-18')) {
                        var n = parseMoney(el.value);
                        if (n !== null && n > 0) clearInvalid(el);
                    }
                });

                el.addEventListener('blur', function () {
                    el.value = formatMoneyVN(el.value);
                    if (el.classList.contains('money-required-18')) {
                        validatePrice18Field(el);
                    }
                });
            });
        }

        function hookSubmitNormalize() {
            var form = document.getElementById('SlotDetailForm');
            if (!form) return;

            form.addEventListener('submit', function (e) {
                if (!validateAllPrice18()) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }

                document.querySelectorAll('.money-input').forEach(function (el) {
                    el.value = normalizeMoney(el.value);
                });

                return true;
            });
        }

        initDatePicker();
        initTimePicker();
        initMoney();
        hookSubmitNormalize();
    })();
</script>
