@page
@using Genora.MultiTenancy.Localization
@using Genora.MultiTenancy.Web.Pages.AppBookings
@using Microsoft.Extensions.Localization
@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
@model EditModalModel
@inject IStringLocalizer<MultiTenancyResource> L

@{
    Layout = null;
}

<form asp-page="/AppBookings/EditModal" method="post" id="EditBookingForm">
    <input type="hidden" asp-for="Id" />

    <!-- Hidden để preserve các field không cho sửa nhưng vẫn post về -->
    <input type="hidden" asp-for="Booking.CustomerId" />
    <input type="hidden" asp-for="Booking.PlayDate" />
    <input type="hidden" asp-for="Booking.GolfCourseId" />
    <input type="hidden" asp-for="Booking.CalendarSlotId" />
    @* <input type="hidden" asp-for="Booking.NumberOfGolfers" /> *@
    <input type="hidden" asp-for="Booking.IsExportInvoice" />
    <input type="hidden" asp-for="Booking.Source" />
    <input type="hidden" asp-for="Booking.IsExportInvoice" />

    <abp-modal>
        <abp-modal-header title="@L["EditAppBooking"]"></abp-modal-header>
        <abp-modal-body>
            <!-- Thông tin tổng quan Booking (read-only) -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>@L["BookingCode"]:</strong> @Model.BookingView.BookingCode
                    </div>
                    <div class="mb-3">
                        <strong>@L["BookingCustomer"]:</strong>
                        @Model.BookingView.CustomerName (@Model.BookingView.CustomerPhone)
                    </div>
                    <div class="mb-3">
                        <strong>@L["BookingGolfCourse"]:</strong> @Model.BookingView.GolfCourseName
                    </div>
                    <div class="mb-3">
                        <strong>@L["BookingPlayDate"]:</strong> @Model.BookingView.PlayDate.ToString("dd/MM/yyyy")
                    </div>
                    <div class="mb-3">
                        <strong>@L["IsExportInvoice"]:</strong> @L[@Model.BookingView.IsExportInvoice.ToString()]
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <strong>@L["NumberHoles"]:</strong> @Model.BookingView.NumberHoles
                    </div>
                    <div class="mb-3">
                        <strong>@L["Utilities"]:</strong> 
                        
                        @if (!string.IsNullOrEmpty(Model.Booking.Utilities) && Model.Booking.UtilityDto.Count > 0)
                        {
                            foreach(var util in Model.Booking.UtilityDto)
                            {
                                <div>
                                    - @L[@util.UtilityName]
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
            <hr />

            <!-- Khu vực cho Admin cập nhật -->
            <div class="mb-3 d-inline-flex" style="width: 98%; gap: 10px">
                <div class="col-md-3">
                    <abp-input asp-for="Booking.NumberOfGolfers" label="@L["BookingNumberOfGolfers"]" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label asp-for="Booking.Status" class="form-label">@L["BookingStatus"]</label>
                    <select asp-for="Booking.Status"
                            asp-items="Model.StatusItems"
                            class="form-control">
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="Booking.PaymentMethod" class="form-label">@L["BookingPaymentMethod"]</label>
                    <select asp-for="Booking.PaymentMethod"
                            asp-items="Model.PaymentMethodItems"
                            class="form-control">
                    </select>
                </div>
                <div class="col-md-3">
                    <abp-input asp-for="Booking.TotalAmount" label="@L["TotalAmount"]" class="form-control thousand-separator" />
                </div>
                
            </div>
        

            <hr />

            <!-- ⭐ Danh sách golfer (BookingPlayers) -->
            <div class="mb-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0">@L["BookingPlayers"]</h6>
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        id="AddPlayerRow">
                    <i class="fa fa-plus"></i> @L["AddPlayer"]
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30%">@L["PlayerName"]</th>
                            <th style="width: 20%">@L["VGA"]</th>
                            <th style="width: 20%">@L["Price"]</th>
                            <th>@L["Notes"]</th>
                            <th style="width: 60px" class="text-center">@L["Actions"]</th>
                        </tr>
                    </thead>
                    <tbody id="booking-players-body" data-next-index="@Model.Booking.Players.Count">
                        @if (Model.Booking.Players != null && Model.Booking.Players.Count > 0)
                        {
                            for (var i = 0; i < Model.Booking.Players.Count; i++)
                            {
                                <tr>
                                    <td>
                                        <input type="hidden"
                                               asp-for="Booking.Players[i].CustomerId" />
                                        <input class="form-control" type="text"
                                               asp-for="Booking.Players[i].PlayerName" />
                                    </td>
                                    <td>
                                        <input class="form-control"
                                               asp-for="Booking.Players[i].VgaCode" />
                                    </td>
                                    <td>
                                        <abp-input class="form-control thousand-separator"
                                               asp-for="Booking.Players[i].PricePerPlayer" />
                                    </td>
                                    <td>
                                        <input class="form-control"
                                               asp-for="Booking.Players[i].Notes" />
                                    </td> 
                                    <td class="text-center">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger remove-player">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </abp-modal-body>
        <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
    </abp-modal>
</form>
<style type="text/css">
    .modal-dialog {
        max-width: 60%;
    }
</style>
<script>
    $(function () {
        var $tbody = $('#booking-players-body');

        function getNextIndex() {
            var current = parseInt($tbody.attr('data-next-index') || '0');
            return current;
        }

        function increaseNextIndex() {
            var current = getNextIndex();
            $tbody.attr('data-next-index', current + 1);
        }

        $('#AddPlayerRow').on('click', function (e) {
            e.preventDefault();

            var index = getNextIndex();

            var rowHtml = ''
                + '<tr>'
                + '  <td>'
                + '    <input type="hidden" '
                + '           name="Booking.Players[' + index + '].CustomerId" '
                + '           value="" />'
                + '    <input class="form-control" '
                + '           name="Booking.Players[' + index + '].PlayerName" '
                + '           value="" />'
                + '  </td>'
                + '    <input class="form-control" '
                + '           name="Booking.Players[' + index + '].VgaCode" '
                + '           value="" />'
                + '  </td>'
                + '    <input class="form-control" '
                + '           name="Booking.Players[' + index + '].PricePerPlayer" '
                + '           value="" />'
                + '  </td>'
                + '  <td>'
                + '    <input class="form-control" '
                + '           name="Booking.Players[' + index + '].Notes" '
                + '           value="" />'
                + '  </td>'
                + '  <td class="text-center">'
                + '    <button type="button" '
                + '            class="btn btn-sm btn-outline-danger remove-player">'
                + '      <i class="fa fa-trash"></i>'
                + '    </button>'
                + '  </td>'
                + '</tr>';

            $tbody.append(rowHtml);
            increaseNextIndex();
            setTimeout(function () {
                $('#booking-players-body .form-control.thousand-separator').not('.formatted')
                    .addClass('formatted')
                    .each(function () {
                        formatNumber(this);
                        $(this).on('input', function () {
                            formatNumber(this);
                        });
                    });
            }, 100);
        });

        $tbody.on('click', '.remove-player', function (e) {
            e.preventDefault();
            $(this).closest('tr').remove();
        });

        function formatNumber(input) {
            var value = $(input).val().replace(/\./g, '');
            var num = parseFloat(value);
            if (!isNaN(num)) {
                $(input).val(num.toLocaleString('en-US').replace(/,/g, '.'));
            } else if (value === '') {
                $(input).val('');
            }
        }

        // Áp dụng format cho tất cả thousand-separator hiện tại
        $('.thousand-separator').each(function () {
            formatNumber(this);

            $(this).on('input', function () {
                formatNumber(this);
            });
        });

        // Clean tất cả dấu chấm TRƯỚC khi submit (để bind decimal đúng)
        $('#EditBookingForm').on('submit', function () {
            $('.thousand-separator').each(function () {
                var value = $(this).val().replace(/\./g, '');
                $(this).val(value);
            });
            // Không preventDefault → để form submit bình thường
        });

    });
    // document.querySelectorAll('.thousand-separator').forEach(function(input) {
    //     // Format khi load trang (display)
    //     if (input.value) {
    //         let num = parseFloat(input.value);
    //         if (!isNaN(num)) {
    //             input.value = num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace(/,/g, ',');
    //         }
    //     }

    //     // Format khi user nhập (on input)
    //     input.addEventListener('input', function(e) {
    //         let value = e.target.value.replace(/\./g, ''); // Xóa dấu chấm cũ
    //         let num = parseFloat(value);
    //         if (!isNaN(num)) {
    //             e.target.value = num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace(/,/g, ',');
    //         } else if (value === '') {
    //             e.target.value = '';
    //         }
    //     });

    //     // Khi submit form, chuyển về dạng số thuần để model binding decimal hoạt động
    //     input.closest('form').addEventListener('submit', function() {
    //         //input.value = input.value.replace(/\./g, '');
    //         debugger;
    //         var amount = $('#Booking_TotalAmount').val();
    //         let cleanValue = amount.replace(/\,/g, '');
    //         if (cleanValue !== '') {
    //             amount = cleanValue; // tạm thời thành số thuần
    //             $(this).valid(); // trigger validation lại (nếu dùng unobtrusive)
    //             // Sau đó format lại để hiển thị đẹp
    //             let num = parseFloat(cleanValue);
    //             if (!isNaN(num)) {
    //                 amount = num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).replace(/,/g, ',');
    //             }
    //         }
    //     });
    // });
</script>